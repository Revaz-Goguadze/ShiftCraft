<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShiftCraft - Leave Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/schedule">
                <i class="fas fa-calendar-alt me-2"></i>ShiftCraft
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/schedule">
                    <i class="fas fa-calendar me-1"></i>Schedule
                </a>
                <a class="nav-link active" href="/requests">
                    <i class="fas fa-paper-plane me-1"></i>Requests
                </a>
                <a class="nav-link" href="/approvals" sec:authorize="hasRole('MANAGER')">
                    <i class="fas fa-check-circle me-1"></i>Approvals
                </a>
                <a class="nav-link" href="/templates" sec:authorize="hasRole('MANAGER')">
                    <i class="fas fa-cog me-1"></i>Templates
                </a>
                <a class="nav-link" href="/timesheets">
                    <i class="fas fa-clock me-1"></i>Timesheets
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- Leave Request Form -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle me-2"></i>Submit Leave Request</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/requests}" th:object="${leaveRequest}" method="post">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" 
                                           th:field="*{startDate}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" 
                                           th:field="*{endDate}" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="leaveType" class="form-label">Leave Type</label>
                                <select class="form-select" id="leaveType" th:field="*{leaveType}" required>
                                    <option value="">Select leave type...</option>
                                    <option th:each="type : ${leaveTypes}" 
                                            th:value="${type}" 
                                            th:text="${type}"></option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="reason" class="form-label">Reason</label>
                                <textarea class="form-control" id="reason" th:field="*{reason}" 
                                          rows="3" placeholder="Please provide reason for leave request..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Submit Request
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- User Info -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user me-2"></i>Your Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Name:</strong> <span th:text="${currentUser.fullName}"></span></p>
                        <p><strong>Email:</strong> <span th:text="${currentUser.email}"></span></p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-success" th:if="${currentUser.status.name() == 'ACTIVE'}">Active</span>
                            <span class="badge bg-warning" th:if="${currentUser.status.name() == 'INACTIVE'}">Inactive</span>
                        </p>
                        
                        <hr>
                        
                        <h6><i class="fas fa-info-circle me-2"></i>Leave Request Guidelines</h6>
                        <ul class="small">
                            <li>Submit requests at least 2 weeks in advance when possible</li>
                            <li>Emergency leave will be reviewed as soon as possible</li>
                            <li>All leave requests require manager approval</li>
                            <li>You will be notified once your request is reviewed</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- My Requests -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>My Leave Requests</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(userRequests)}" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>You have not submitted any leave requests yet.</p>
                        </div>
                        
                        <div th:unless="${#lists.isEmpty(userRequests)}">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Days</th>
                                            <th>Status</th>
                                            <th>Submitted</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="request : ${userRequests}">
                                            <td>
                                                <span class="badge bg-info" th:text="${request.leaveType}"></span>
                                            </td>
                                            <td th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></td>
                                            <td th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></td>
                                            <td>
                                                <span th:text="${request.durationDays}"></span> day(s)
                                            </td>
                                            <td>
                                                <span th:switch="${request.status}" class="badge">
                                                    <span th:case="'PENDING'" class="badge bg-warning">Pending</span>
                                                    <span th:case="'APPROVED'" class="badge bg-success">Approved</span>
                                                    <span th:case="'REJECTED'" class="badge bg-danger">Rejected</span>
                                                    <span th:case="'CANCELLED'" class="badge bg-secondary">Cancelled</span>
                                                </span>
                                            </td>
                                            <td th:text="${#temporals.format(request.requestedAt, 'MMM dd, yyyy')}"></td>
                                            <td>
                                                <div th:if="${request.status.name() == 'PENDING'}" class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#detailModal' + ${request.id}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <form th:action="@{/requests/{id}/cancel(id=${request.id})}" 
                                                          method="post" style="display: inline;">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                                onclick="return confirm('Are you sure you want to cancel this request?')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                                
                                                <div th:unless="${request.status.name() == 'PENDING'}">
                                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#detailModal' + ${request.id}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modals -->
    <div th:each="request : ${userRequests}">
        <div class="modal fade" th:id="'detailModal' + ${request.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Leave Request Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Type:</strong> <span th:text="${request.leaveType}"></span></p>
                        <p><strong>Period:</strong> 
                           <span th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></span> to 
                           <span th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></span>
                           (<span th:text="${request.durationDays}"></span> days)
                        </p>
                        <p><strong>Reason:</strong> <span th:text="${request.reason ?: 'No reason provided'}"></span></p>
                        <p><strong>Status:</strong> <span th:text="${request.status}"></span></p>
                        <p><strong>Submitted:</strong> <span th:text="${#temporals.format(request.requestedAt, 'MMM dd, yyyy HH:mm')}"></span></p>
                        
                        <div th:if="${request.reviewedAt != null}">
                            <hr>
                            <p><strong>Reviewed:</strong> <span th:text="${#temporals.format(request.reviewedAt, 'MMM dd, yyyy HH:mm')}"></span></p>
                            <p th:if="${request.reviewNotes != null}"><strong>Review Notes:</strong> <span th:text="${request.reviewNotes}"></span></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>