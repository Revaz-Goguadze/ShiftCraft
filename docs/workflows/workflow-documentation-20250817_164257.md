<!--
Generated by Claude Code Documentation Organizer
Created: 2025-08-17T16:42:57.065645
Session: 20250817_164257
Type: workflow_documentation
-->

{"session_id":"c9f37bdf-cae0-49f8-ac76-60c632a1bc71","transcript_path":"/home/coder/.claude/projects/-home-coder-epam-shiftcraft/c9f37bdf-cae0-49f8-ac76-60c632a1bc71.jsonl","cwd":"/home/coder/epam/shiftcraft","hook_event_name":"PostToolUse","tool_name":"Edit","tool_input":{"file_path":"/home/coder/epam/shiftcraft/docs/stage3.md","old_string":"Perfect, let's lock down Stage 3 for ShiftCraft. I'll follow the four steps exactly and give you a submission-ready ER model plus an SQL DDL starter you can push in a merge request.\n\n# Stage 3. Capstone Project Database Layer Design","new_string":"# ShiftCraft - Stage 3 Database Design"},"tool_response":{"filePath":"/home/coder/epam/shiftcraft/docs/stage3.md","oldString":"Perfect, let’s lock down Stage 3 for ShiftCraft. I’ll follow the four steps exactly and give you a submission-ready ER model plus an SQL DDL starter you can push in a merge request.\n\n# Stage 3. Capstone Project Database Layer Design","newString":"# ShiftCraft - Stage 3 Database Design","originalFile":"Perfect, let’s lock down Stage 3 for ShiftCraft. I’ll follow the four steps exactly and give you a submission-ready ER model plus an SQL DDL starter you can push in a merge request.\n\n# Stage 3. Capstone Project Database Layer Design\n\nSystem: ShiftCraft — staff scheduling and time management for small clinics and labs\n\n## Step 1. Identify entities and their types\n\n### Key (strong) entities\n\n1. User\n2. Role\n3. Skill\n4. Location\n5. ShiftTemplate\n6. SwapRequest\n7. LeaveRequest\n8. Timesheet\n9. AuditEvent\n10. RuleConfig\n\n### Weak entities\n\n1. ShiftInstance\n   Depends on ShiftTemplate and Date. Natural identifying relationship is (template\\_id, shift\\_date). You may still keep a surrogate id for convenience, but model the dependency in the ERD.\n2. SwapApprovalStep\n   Depends on SwapRequest with weak key step\\_no to preserve the approval timeline.\n\n### Associative entities\n\n1. UserRole relates User ↔ Role\n2. UserSkill relates User ↔ Skill\n3. TemplateSkillRequirement relates ShiftTemplate ↔ Skill\n4. Assignment relates User ↔ ShiftInstance\n5. TimesheetEntry relates Timesheet ↔ Assignment\n\nThat gives you 15 unique entities with clear types and names.\n\n## Step 2. Identify relationships\n\nI show the relationship verb, direction, and business meaning.\n\n1. User has Role through UserRole\n2. User has Skill through UserSkill\n3. Location contains ShiftTemplate\n4. ShiftTemplate requires Skill through TemplateSkillRequirement\n5. ShiftTemplate generates ShiftInstance\n6. ShiftInstance is assigned to User through Assignment\n7. User submits LeaveRequest\n8. Manager approves LeaveRequest recorded in AuditEvent\n9. User initiates SwapRequest for a specific Assignment\n10. SwapRequest contains SwapApprovalStep\n11. Manager approves SwapRequest recorded in AuditEvent and results in reassigned Assignments\n12. Timesheet aggregates TimesheetEntry\n13. TimesheetEntry references Assignment\n14. RuleConfig applies to Location or Role or Global scope\n15. System records AuditEvent for any state change and references the actor User\n\n## Step 3. Cardinality and ordinality\n\nNotation min..max. Optionality explained after each.\n\n1. User 1..\\* ↔ 1..\\* Role via UserRole\n   UserRole has PK (user\\_id, role\\_id). Both sides optional at creation, but a Staff user must have at least one role for access.\n\n2. User 0..\\* ↔ 1..\\* Skill via UserSkill\n   Optional for both.\n\n3. Location 1..\\* → 0..\\* ShiftTemplate\n   Each template belongs to exactly one location. A location can exist before templates.\n\n4. ShiftTemplate 1 → 0..\\* ShiftInstance\n   Template can exist without generated instances. A shift instance must have a template. Optionality: ShiftInstance min is zero.\n\n5. ShiftTemplate 0..\\* ↔ 1..\\* Skill via TemplateSkillRequirement\n   Optional to allow simple roles without skills.\n\n6. ShiftInstance 0..1 ↔ 0..\\* User via Assignment\n   Most clinics have one person per shift instance. Allow 0..\\* Users through Assignment for edge cases like overlapping handover or shadowing. If you need strict one assignee, set a unique index on Assignment per shift\\_instance\\_id and status = active.\n\n7. User 0..\\* → 0..\\* LeaveRequest\n   A request belongs to one user; a user can have many requests, possibly zero.\n\n8. User 0..\\* → 0..\\* SwapRequest\n   An initiator creates many swap requests. A swap references exactly one source Assignment and one target User.\n\n9. SwapRequest 1 → 1..\\* SwapApprovalStep\n   At least one step exists after creation. step\\_no starts at 1.\n\n10. Timesheet 1 → 1..\\* TimesheetEntry\n    A timesheet is not empty. Each entry references exactly one Assignment.\n\n11. Assignment 1 → 0..1 TimesheetEntry\n    At most one entry per assignment per period.\n\n12. User 1 → 0..\\* AuditEvent\n    Events always have an actor. System-generated events can use a special System user.\n\n13. RuleConfig 0..\\* → 0..\\* Location or Role\n    Rule can be global or scoped. Enforce scope by nullable foreign keys with a scope\\_type discriminator.\n\n## Step 4. Attributes per entity and their types\n\nLegend\nPK key attribute, WK weak key, D derived, MV multivalued\n\n### User \\[key]\n\nid PK, email unique, first\\_name, last\\_name, status, created\\_at\nD full\\_name = first\\_name || ' ' || last\\_name\nMV phones represented as child entity UserPhone if you want a concrete MV example: id PK, user\\_id FK, phone\\_number\n\n### Role \\[key]\n\nid PK, name unique\n\n### Skill \\[key]\n\nid PK, name unique\n\n### UserRole \\[associative]\n\nuser\\_id PK,FK → User, role\\_id PK,FK → Role, granted\\_at\n\n### UserSkill \\[associative]\n\nuser\\_id PK,FK → User, skill\\_id PK,FK → Skill, level optional enum beginner intermediate expert\n\n### Location \\[key]\n\nid PK, name, timezone, address\\_line, city\n\n### ShiftTemplate \\[key]\n\nid PK, location\\_id FK, role\\_id FK, start\\_time, end\\_time, break\\_minutes, name, recurrence weekly mask if you later auto generate\n\n### TemplateSkillRequirement \\[associative]\n\ntemplate\\_id PK,FK → ShiftTemplate, skill\\_id PK,FK → Skill\n\n### ShiftInstance \\[weak]\n\nid PK surrogate, template\\_id FK, shift\\_date WK component, status enum DRAFT PUBLISHED CANCELLED\nBusiness identifier can be (template\\_id, shift\\_date). Keep unique(template\\_id, shift\\_date).\n\n### Assignment \\[associative]\n\nid PK, shift\\_instance\\_id FK, user\\_id FK, status enum ACTIVE CANCELLED SWAPPED, assigned\\_at, assigned\\_by FK → User\n\n### LeaveRequest \\[key]\n\nid PK, user\\_id FK, type enum VACATION SICK UNPAID, start\\_at, end\\_at, status enum PENDING APPROVED REJECTED, manager\\_comment, created\\_at, decided\\_at\n\n### SwapRequest \\[key]\n\nid PK, source\\_assignment\\_id FK, initiator\\_id FK → User, target\\_user\\_id FK → User, status enum PROPOSED ACCEPTED AWAITING\\_APPROVAL APPROVED REJECTED, created\\_at, decided\\_at\n\n### SwapApprovalStep \\[weak]\n\nswap\\_request\\_id PK,FK → SwapRequest, step\\_no WK, actor\\_id FK → User, decision enum PROPOSE ACCEPT DECLINE APPROVE REJECT, comment, decided\\_at\n\n### Timesheet \\[key]\n\nid PK, user\\_id FK, period\\_start, period\\_end, created\\_at\nD total\\_hours computed from entries\nD overtime\\_hours computed via rules\n\n### TimesheetEntry \\[associative]\n\nid PK, timesheet\\_id FK, assignment\\_id FK unique per timesheet, hours\\_worked, overtime\\_hours\n\n### AuditEvent \\[key]\n\nid PK, actor\\_id FK → User, entity\\_type, entity\\_id, action, payload\\_json, created\\_at\n\n### RuleConfig \\[key]\n\nid PK, scope enum GLOBAL LOCATION ROLE, location\\_id nullable FK, role\\_id nullable FK, name, value\\_text\nExamples: MIN\\_REST\\_HOURS=12, WEEKLY\\_MAX\\_HOURS=48\n\n## ER diagram (Mermaid ER)\n\nYou can paste this into any Mermaid renderer.\n\n```mermaid\nerDiagram\n  User ||--o{ UserRole : has\n  Role ||--o{ UserRole : in\n  User ||--o{ UserSkill : has\n  Skill ||--o{ UserSkill : is\n  Location ||--o{ ShiftTemplate : contains\n  ShiftTemplate ||--o{ TemplateSkillRequirement : requires\n  Skill ||--o{ TemplateSkillRequirement : neededBy\n  ShiftTemplate ||--o{ ShiftInstance : generates\n  ShiftInstance ||--o{ Assignment : has\n  User ||--o{ Assignment : takes\n  User ||--o{ LeaveRequest : submits\n  Assignment ||--o{ SwapRequest : sourceOf\n  User ||--o{ SwapRequest : initiates\n  User ||--o{ SwapRequest : target\n  SwapRequest ||--|{ SwapApprovalStep : contains\n  Timesheet ||--|{ TimesheetEntry : includes\n  Assignment ||--|{ TimesheetEntry : accountedBy\n  User ||--o{ AuditEvent : acts\n```\n\nCardinality note\n\\| is 1, } is many, o is zero. For example Timesheet ||--|{ TimesheetEntry means one Timesheet to one or many entries.\n\n## Relational schema starter (PostgreSQL DDL)\n\nThis is ready to drop into a Flyway V1\\_\\_baseline.sql. It encodes keys, weak keys, associative tables, and important unique and check constraints.\n\n```sql\ncreate type shift_status as enum ('DRAFT','PUBLISHED','CANCELLED');\ncreate type assign_status as enum ('ACTIVE','CANCELLED','SWAPPED');\ncreate type leave_type as enum ('VACATION','SICK','UNPAID');\ncreate type decision as enum ('PROPOSE','ACCEPT','DECLINE','APPROVE','REJECT');\ncreate type request_status as enum ('PROPOSED','ACCEPTED','AWAITING_APPROVAL','APPROVED','REJECTED');\n\ncreate table users (\n  id uuid primary key,\n  email text not null unique,\n  first_name text not null,\n  last_name text not null,\n  status text not null default 'ACTIVE',\n  created_at timestamptz not null default now()\n);\n\ncreate table roles (\n  id uuid primary key,\n  name text not null unique\n);\n\ncreate table skills (\n  id uuid primary key,\n  name text not null unique\n);\n\ncreate table user_roles (\n  user_id uuid references users(id) on delete cascade,\n  role_id uuid references roles(id) on delete restrict,\n  granted_at timestamptz not null default now(),\n  primary key (user_id, role_id)\n);\n\ncreate table user_skills (\n  user_id uuid references users(id) on delete cascade,\n  skill_id uuid references skills(id) on delete restrict,\n  level text,\n  primary key (user_id, skill_id)\n);\n\ncreate table locations (\n  id uuid primary key,\n  name text not null,\n  timezone text not null,\n  address_line text,\n  city text\n);\n\ncreate table shift_templates (\n  id uuid primary key,\n  location_id uuid not null references locations(id) on delete restrict,\n  role_id uuid not null references roles(id) on delete restrict,\n  name text not null,\n  start_time time not null,\n  end_time time not null,\n  break_minutes int not null default 0,\n  recurrence int\n);\n\ncreate table template_skill_requirements (\n  template_id uuid references shift_templates(id) on delete cascade,\n  skill_id uuid references skills(id) on delete restrict,\n  primary key (template_id, skill_id)\n);\n\ncreate table shift_instances (\n  id uuid primary key,\n  template_id uuid not null references shift_templates(id) on delete cascade,\n  shift_date date not null,\n  status shift_status not null default 'DRAFT',\n  unique (template_id, shift_date)\n);\n\ncreate table assignments (\n  id uuid primary key,\n  shift_instance_id uuid not null references shift_instances(id) on delete cascade,\n  user_id uuid not null references users(id) on delete restrict,\n  status assign_status not null default 'ACTIVE',\n  assigned_at timestamptz not null default now(),\n  assigned_by uuid references users(id)\n  -- if you want exactly one active assignee per shift:\n  -- , unique (shift_instance_id) where (status = 'ACTIVE')\n);\n\ncreate table leave_requests (\n  id uuid primary key,\n  user_id uuid not null references users(id) on delete restrict,\n  type leave_type not null,\n  start_at timestamptz not null,\n  end_at timestamptz not null,\n  status text not null default 'PENDING',\n  manager_comment text,\n  created_at timestamptz not null default now(),\n  decided_at timestamptz\n);\n\ncreate table swap_requests (\n  id uuid primary key,\n  source_assignment_id uuid not null references assignments(id) on delete cascade,\n  initiator_id uuid not null references users(id) on delete restrict,\n  target_user_id uuid not null references users(id) on delete restrict,\n  status request_status not null default 'PROPOSED',\n  created_at timestamptz not null default now(),\n  decided_at timestamptz\n);\n\ncreate table swap_approval_steps (\n  swap_request_id uuid not null references swap_requests(id) on delete cascade,\n  step_no int not null,\n  actor_id uuid not null references users(id) on delete restrict,\n  decision decision not null,\n  comment text,\n  decided_at timestamptz not null default now(),\n  primary key (swap_request_id, step_no)\n);\n\ncreate table timesheets (\n  id uuid primary key,\n  user_id uuid not null references users(id) on delete restrict,\n  period_start date not null,\n  period_end date not null,\n  created_at timestamptz not null default now(),\n  unique(user_id, period_start, period_end)\n);\n\ncreate table timesheet_entries (\n  id uuid primary key,\n  timesheet_id uuid not null references timesheets(id) on delete cascade,\n  assignment_id uuid not null references assignments(id) on delete restrict,\n  hours_worked numeric(5,2) not null,\n  overtime_hours numeric(5,2) not null default 0,\n  unique(timesheet_id, assignment_id)\n);\n\ncreate table audit_events (\n  id uuid primary key,\n  actor_id uuid not null references users(id) on delete set null,\n  entity_type text not null,\n  entity_id uuid not null,\n  action text not null,\n  payload_json jsonb not null default '{}',\n  created_at timestamptz not null default now()\n);\n\ncreate table rule_configs (\n  id uuid primary key,\n  scope text not null check (scope in ('GLOBAL','LOCATION','ROLE')),\n  location_id uuid references locations(id) on delete cascade,\n  role_id uuid references roles(id) on delete cascade,\n  name text not null,\n  value_text text not null\n);\n```\n\n### Derived attributes as views\n\nKeep derived data consistent and explain it to the reviewer.\n\n```sql\ncreate view v_timesheet_totals as\nselect t.id as timesheet_id,\n       sum(e.hours_worked) as total_hours,\n       sum(e.overtime_hours) as overtime_hours\nfrom timesheet_entries e\njoin timesheets t on t.id = e.timesheet_id\ngroup by t.id;\n```\n\n### Multivalued attributes\n\nSkills for a user are multivalued and normalized via UserSkill. If you want a second clear MV example, add UserPhone:\n\n```sql\ncreate table user_phones (\n  id uuid primary key,\n  user_id uuid not null references users(id) on delete cascade,\n  phone_number text not null,\n  unique(user_id, phone_number)\n);\n```\n\n## Notes for your ERD diagram\n\n• Mark ShiftInstance as a weak entity with a partial key shift\\_date, owned by ShiftTemplate\n• Mark SwapApprovalStep as a weak entity owned by SwapRequest with WK step\\_no\n• Label associative entities with diamond or note, depending on your diagramming tool\n• Show optionality with 0..1 and 0..\\* near the optional side\n\n## What to put in the merge request\n\n1. docs/erd/shiftcraft-erd.mmd with the Mermaid ER from above\n2. db/migration/V1\\_\\_baseline.sql with the DDL\n3. docs/erd/readme.md explaining key, weak, and associative choices in two paragraphs\n4. A screenshot or exported PDF of the ERD from your tool\n\n## Submission text you can paste\n\nTitle\nStage 3. Capstone Project Database Layer Design\n\nSummary\nI identified strong, weak, and associative entities for ShiftCraft and produced an ER diagram with correct relationships, cardinalities, and optionalities. The schema distinguishes business identifiers and technical surrogate keys, models multivalued attributes through associative tables, and keeps derived attributes as views for consistency.\n\nEntities and types\nKey entities: User, Role, Skill, Location, ShiftTemplate, SwapRequest, LeaveRequest, Timesheet, AuditEvent, RuleConfig\nWeak entities: ShiftInstance identified by (template\\_id, shift\\_date), SwapApprovalStep identified by (swap\\_request\\_id, step\\_no)\nAssociative entities: UserRole, UserSkill, TemplateSkillRequirement, Assignment, TimesheetEntry\n\nRelationships and cardinalities\nDetailed in the ERD. Examples: ShiftTemplate 1 to many ShiftInstance, Assignment relates User many to many ShiftInstance with optionality zero to many on both sides, Timesheet 1 to many TimesheetEntry\n\nAttributes\nKeys, weak keys, derived totals, and multivalued skills are specified per entity. Derived totals are exposed as a view v\\_timesheet\\_totals. Multivalued attributes are normalized into UserSkill and optional UserPhone.\n\nMerge request link <your MR link here>\n\nIf you want, I can also generate a neatly formatted PDF from this content with the Mermaid diagram embedded.\n\n","structuredPatch":[{"oldStart":1,"oldLines":7,"newStart":1,"newLines":5,"lines":["-Perfect, let’s lock down Stage 3 for ShiftCraft. I’ll follow the four steps exactly and give you a submission-ready ER model plus an SQL DDL starter you can push in a merge request.","+# ShiftCraft - Stage 3 Database Design"," ","-# Stage 3. Capstone Project Database Layer Design","-"," System: ShiftCraft — staff scheduling and time management for small clinics and labs"," "," ## Step 1. Identify entities and their types"]}],"userModified":false,"replaceAll":false}}