<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShiftCraft - Approvals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/schedule">
                <i class="fas fa-calendar-alt me-2"></i>ShiftCraft
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/schedule">
                    <i class="fas fa-calendar me-1"></i>Schedule
                </a>
                <a class="nav-link" href="/requests" sec:authorize="hasRole('STAFF')">
                    <i class="fas fa-paper-plane me-1"></i>Requests
                </a>
                <a class="nav-link active" href="/approvals" sec:authorize="hasRole('MANAGER')">
                    <i class="fas fa-check-circle me-1"></i>Approvals
                </a>
                <a class="nav-link" href="/templates" sec:authorize="hasRole('MANAGER')">
                    <i class="fas fa-cog me-1"></i>Templates
                </a>
                <a class="nav-link" href="/timesheets">
                    <i class="fas fa-clock me-1"></i>Timesheets
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-tasks me-2"></i>Pending Approvals</h2>
                <p class="text-muted">Review and approve leave requests and timesheets from your team.</p>
            </div>
        </div>

        <!-- Pending Leave Requests -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-plane me-2"></i>Leave Requests 
                            <span class="badge bg-warning ms-2" th:text="${#lists.size(pendingLeaveRequests)}"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(pendingLeaveRequests)}" class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                            <p>No pending leave requests! All caught up.</p>
                        </div>
                        
                        <div th:unless="${#lists.isEmpty(pendingLeaveRequests)}">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Staff Member</th>
                                            <th>Leave Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Days</th>
                                            <th>Submitted</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="request : ${pendingLeaveRequests}">
                                            <td>
                                                <strong th:text="${request.user.fullName}"></strong><br>
                                                <small class="text-muted" th:text="${request.user.email}"></small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info" th:text="${request.leaveType}"></span>
                                            </td>
                                            <td th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></td>
                                            <td th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></td>
                                            <td><span th:text="${request.durationDays}"></span> day(s)</td>
                                            <td th:text="${#temporals.format(request.requestedAt, 'MMM dd')}"></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-info" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#leaveModal' + ${request.id}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#approveModal' + ${request.id}">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#rejectModal' + ${request.id}">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Timesheets -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-clock me-2"></i>Timesheet Approvals
                            <span class="badge bg-warning ms-2" th:text="${#lists.size(submittedTimesheets)}"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(submittedTimesheets)}" class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                            <p>No pending timesheet approvals! All caught up.</p>
                        </div>
                        
                        <div th:unless="${#lists.isEmpty(submittedTimesheets)}">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Staff Member</th>
                                            <th>Period</th>
                                            <th>Total Hours</th>
                                            <th>Regular Hours</th>
                                            <th>Overtime Hours</th>
                                            <th>Generated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="timesheet : ${submittedTimesheets}">
                                            <td>
                                                <strong th:text="${timesheet.user.fullName}"></strong><br>
                                                <small class="text-muted" th:text="${timesheet.user.email}"></small>
                                            </td>
                                            <td>
                                                <span th:text="${#temporals.format(timesheet.periodStart, 'MMM dd')}"></span> - 
                                                <span th:text="${#temporals.format(timesheet.periodEnd, 'MMM dd, yyyy')}"></span>
                                            </td>
                                            <td><strong th:text="${timesheet.totalHours}"></strong>h</td>
                                            <td th:text="${timesheet.regularHours}">h</td>
                                            <td>
                                                <span th:if="${timesheet.overtimeHours.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                                      class="text-warning fw-bold" th:text="${timesheet.overtimeHours} + 'h'"></span>
                                                <span th:unless="${timesheet.overtimeHours.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                                      class="text-muted">0h</span>
                                            </td>
                                            <td th:text="${#temporals.format(timesheet.generatedAt, 'MMM dd')}"></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-info">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <form th:action="@{/approvals/timesheet/{id}/approve(id=${timesheet.id})}" 
                                                          method="post" style="display: inline;">
                                                        <button type="submit" class="btn btn-outline-success btn-sm"
                                                                onclick="return confirm('Approve this timesheet?')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Request Modals -->
    <div th:each="request : ${pendingLeaveRequests}">
        <!-- Detail Modal -->
        <div class="modal fade" th:id="'leaveModal' + ${request.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Leave Request Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Staff Member:</strong> <span th:text="${request.user.fullName}"></span></p>
                        <p><strong>Email:</strong> <span th:text="${request.user.email}"></span></p>
                        <p><strong>Leave Type:</strong> <span th:text="${request.leaveType}"></span></p>
                        <p><strong>Period:</strong> 
                           <span th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></span> to 
                           <span th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></span>
                           (<span th:text="${request.durationDays}"></span> days)
                        </p>
                        <p><strong>Reason:</strong> <span th:text="${request.reason ?: 'No reason provided'}"></span></p>
                        <p><strong>Submitted:</strong> <span th:text="${#temporals.format(request.requestedAt, 'MMM dd, yyyy HH:mm')}"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approve Modal -->
        <div class="modal fade" th:id="'approveModal' + ${request.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Approve Leave Request</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/approvals/leave/{id}/approve(id=${request.id})}" method="post">
                        <div class="modal-body">
                            <p>Are you sure you want to approve this leave request for 
                               <strong th:text="${request.user.fullName}"></strong>?</p>
                            <p><strong>Period:</strong> 
                               <span th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></span> to 
                               <span th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></span>
                            </p>
                            <div class="mb-3">
                                <label for="approveNotes" class="form-label">Notes (optional)</label>
                                <textarea class="form-control" name="notes" rows="3" 
                                          placeholder="Add any notes about the approval..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Approve Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reject Modal -->
        <div class="modal fade" th:id="'rejectModal' + ${request.id}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i>Reject Leave Request</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/approvals/leave/{id}/reject(id=${request.id})}" method="post">
                        <div class="modal-body">
                            <p>Are you sure you want to reject this leave request for 
                               <strong th:text="${request.user.fullName}"></strong>?</p>
                            <p><strong>Period:</strong> 
                               <span th:text="${#temporals.format(request.startDate, 'MMM dd, yyyy')}"></span> to 
                               <span th:text="${#temporals.format(request.endDate, 'MMM dd, yyyy')}"></span>
                            </p>
                            <div class="mb-3">
                                <label for="rejectNotes" class="form-label">Reason for rejection <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="notes" rows="3" required
                                          placeholder="Please provide a reason for rejecting this request..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-times me-2"></i>Reject Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>